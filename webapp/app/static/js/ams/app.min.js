var ams=ams||{};ams.App={zoomThreshold:11,_layerControl:null,_baseLayers:[],_addedLayers:[],_borderLayer:null,_appClassGroups:null,_suViewParams:null,_priorViewParams:null,_wfs:null,_dateControl:null,_baseURL:null,_indicator:null,_propertyName:null,_riskThreshold:0,_referenceLayerName:null,_currentSULayerName:null,_hasClassFilter:!1,_diffOn:!1,_currentTemporalAggregate:null,_currentClassify:null,_spatialUnits:null,_landUseList:[],_biomes:[],_subset:null,_municipalitiesGroup:null,_geocodes:null,run:function(geoserverUrl,spatialUnits,appClassGroups){this._spatialUnits=spatialUnits,this._appClassGroups=appClassGroups,this._landUseList=ams.Config.landUses.map(lu=>lu.id),this._biomes=ams.Config.appSelectedBiomes,this._subset=ams.Config.appSelectedSubset,this._municipalitiesGroup=ams.Config.appSelectedMunicipalitiesGroup,this._geocodes=ams.Config.appSelectedGeocodes,this._wfs=new ams.Map.WFS(geoserverUrl);var ldLayerName=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.lastDate,temporalUnits=new ams.Map.TemporalUnits;this._dateControl=new ams.Date.DateController;let lastDateDynamic=this._wfs.getLastDate(ldLayerName);lastDateDynamic=lastDateDynamic||this._spatialUnits.getDefault().last_date,ams.PeriodHandler.setMaxDate(lastDateDynamic);let startDate=ams.Config.startDate,tempUnit=ams.Config.tempUnit;this._currentTemporalAggregate=temporalUnits.getAggregates()[0].key,startDate&&ams.Date.isAfter(lastDateDynamic,startDate)&&"custom"!==tempUnit?(ams.App._dateControl.setPeriod(startDate,tempUnit),this._currentTemporalAggregate=tempUnit):ams.App._dateControl.setPeriod(lastDateDynamic,this._currentTemporalAggregate),this._baseURL=geoserverUrl+"/wms",this._setIndicator(ams.Config.defaultFilters.indicator);var map=new L.Map("map",{zoomControl:!1,minZoom:4});this._map=map,ams.LeafletControlPosition.addNewPositions(map),map.fitBounds([[ams.Config.bbox[2],ams.Config.bbox[0]],[ams.Config.bbox[3],ams.Config.bbox[1]]],{padding:[100*(1==this._geocodes.length&&this._geocodes[0].length>0),100*(1==this._geocodes.length&&this._geocodes[0].length>0)]}),this._baseLayers.osm=new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:18,minZoom:4}).addTo(map);let options={attribution:'&copy; <a href="https://www.google.com/maps/">Google Maps</a>',maxZoom:18,minZoom:4,subdomains:["mt0","mt1","mt2","mt3"]},googlelayers=[{index:"gs",name:"Google Satellite",param:"s"},{index:"gh",name:"Google Hybrid",param:"s,h"},{index:"gst",name:"Google Streets",param:"m"},{index:"gte",name:"Google Terrain",param:"p"}];for(let i in googlelayers){let host="https://{s}.google.com/vt/lyrs="+googlelayers[i].param+"&x={x}&y={y}&z={z}";options.name=googlelayers[i].name,this._baseLayers[googlelayers[i].index]=new L.TileLayer(host,options)}this._baseLayers.blank=new L.TileLayer(""),L.control.zoom({position:"topright"}).addTo(map),L.control.scale({position:"bottomright"}).addTo(map),map.on("zoomend",(function(e){let currZoom=map.getZoom(),l=ams.App._getLayerByName(ams.App._referenceLayerName);l&&(currZoom>=ams.App.zoomThreshold?l.bringToFront():l.bringToBack())})),this._suViewParams=new ams.Map.ViewParams(ams.Config.defaultFilters.indicator,ams.App._dateControl,ams.App._propertyName,"ALL"),this._priorViewParams=new ams.Map.ViewParams(ams.Config.defaultFilters.indicator,ams.App._dateControl,ams.App._propertyName,ams.Config.defaultFilters.priorityLimit);var tbDeterAlertsLayerName=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.deter,tbDeterAlertsWmsOptions={cql_filter:appClassGroups.getCqlFilter(this._suViewParams,!0),viewparams:"landuse:"+ams.App._landUseList.join("\\,")+";biomes:"+ams.App._biomes.join("\\,")+";municipality_group_name:"+ams.App._municipalitiesGroup+";geocodes:"+ams.App._geocodes.join("\\,")};ams.App._addWmsOptionsBase(tbDeterAlertsWmsOptions);var AFLayerName=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.activeFire,AFWmsOptions={cql_filter:appClassGroups.getCqlFilter(this._suViewParams,!1),viewparams:"landuse:"+ams.App._landUseList.join("\\,")+";biomes:"+ams.App._biomes.join("\\,")+";municipality_group_name:"+ams.App._municipalitiesGroup+";geocodes:"+ams.App._geocodes.join("\\,")};ams.App._addWmsOptionsBase(AFWmsOptions);var riskLayer="inpe"===ams.Config.defaultRiskFilter.source?ams.Config.defaultLayers.inpeRisk:ams.Config.defaultLayers.ibamaRisk,RKLayerName=ams.Auth.getWorkspace()+":"+riskLayer,RKWmsOptions={cql_filter:"(risk >= "+ams.Config.defaultRiskFilter.threshold+")",viewparams:"landuse:"+ams.App._landUseList.join("\\,")+";biomes:"+ams.App._biomes.join("\\,")+";municipality_group_name:"+ams.App._municipalitiesGroup+";geocodes:"+ams.App._geocodes.join("\\,")};ams.App._addWmsOptionsBase(RKWmsOptions);var tbDeterAlertsSource=new ams.LeafletWms.Source(this._baseURL,tbDeterAlertsWmsOptions,appClassGroups),AFSource=new ams.LeafletWms.Source(this._baseURL,AFWmsOptions,appClassGroups),RKSource=new ams.LeafletWms.Source(this._baseURL,RKWmsOptions,appClassGroups),tbDeterAlertsLayer=tbDeterAlertsSource.getLayer(tbDeterAlertsLayerName);let AFLayer=AFSource.getLayer(AFLayerName),RKLayer=RKSource.getLayer(RKLayerName);this._referenceLayerName==tbDeterAlertsLayerName?(tbDeterAlertsLayer.addTo(map),tbDeterAlertsLayer.bringToBack()):this._referenceLayerName==AFLayerName?(AFLayer.addTo(map),AFLayer.bringToBack()):this._referenceLayerName==RKLayerName?(RKLayer.addTo(map),RKLayer.bringToBack()):ams.Utils.assert(!1,"invalid layer name"),this._addedLayers[tbDeterAlertsLayerName]=tbDeterAlertsLayer,this._addedLayers[AFLayerName]=AFLayer,this._addedLayers[RKLayerName]=RKLayer,this._legendControl=new ams.Map.LegendController(map,this._baseURL),this._currentSULayerName=ams.Auth.getWorkspace()+":"+this._spatialUnits.getDefault().dataname,ams.Config.defaultFilters.spatialUnit=this._spatialUnits.getDefault().dataname,this._addSpatialUnitLayer(this._getLayerPrefix(),this._propertyName);var tbBorderLayerName=ams.Auth.getWorkspace()+":"+("Bioma"==this._subset?ams.Config.defaultLayers.biomeBorder:ams.Config.defaultLayers.municipalitiesBorder),onlyWmsBase={identify:!1,viewparams:"biomes:"+ams.App._biomes.join("\\,")+";municipality_group_name:"+ams.App._municipalitiesGroup+";geocodes:"+ams.App._geocodes.join("\\,")};ams.App._addWmsOptionsBase(onlyWmsBase);var tbBorderSource=new ams.LeafletWms.Source(this._baseURL,onlyWmsBase,this._appClassGroups);ams.App._borderLayer=tbBorderSource.getLayer(tbBorderLayerName),ams.App._borderLayer.addTo(map).bringToBack();var controlGroups={"RECORTE BIOMA":{type:"selectControl",defaultFilter:ams.Config.appSelectedBiomes[0],defaultSubset:ams.Config.appSelectedSubset,group:"RECORTE",name:"Bioma",values:ams.Config.allBiomes},"RECORTE MUNICIPIOS":{type:"selectControl",defaultFilter:ams.Config.appSelectedMunicipalitiesGroup,defaultSubset:ams.Config.appSelectedSubset,group:"RECORTE",name:"Municípios de Interesse",values:ams.Config.allMunicipalitiesGroup},INDICADOR:{defaultFilter:ams.Config.defaultFilters.indicator,propertyName:this._propertyName,type:"simpleControl"},"CATEGORIA FUNDIÁRIA":{defaultFilter:"",type:"simpleControl"},"UNIDADE ESPACIAL":{defaultFilter:ams.Config.defaultFilters.spatialUnit,type:"simpleControl"},"UNIDADE TEMPORAL":{defaultFilter:ams.Config.defaultFilters.temporalUnit,type:"simpleControl"},"CLASSIFICAÇÃO DO MAPA":{defaultFilter:ams.Config.defaultFilters.diffClassify,type:"simpleControl"}};for(let p in ams.Config.landUses)ams.Config.landUses.hasOwnProperty(p)&&ams.Config.landUses[p]&&(controlGroups["CATEGORIA FUNDIÁRIA"].defaultFilter+=(""==controlGroups["CATEGORIA FUNDIÁRIA"].defaultFilter?"":",")+ams.Config.landUses[p].id,controlGroups["CATEGORIA FUNDIÁRIA"][ams.Config.landUses[p].name]=""+ams.Config.landUses[p].id);let sulen=this._spatialUnits.length();for(var i=0;i<sulen;i++){let layerName=ams.Auth.getWorkspace()+":"+this._spatialUnits.at(i).dataname;controlGroups["UNIDADE ESPACIAL"][this._spatialUnits.at(i).description]=layerName}let cglen=appClassGroups.length();for(var i=0;i<cglen;i++)controlGroups.INDICADOR[appClassGroups.at(i).name]=appClassGroups.at(i).acronym;for(var temporalUnitAggregates=temporalUnits.getAggregates(),i=0;i<Object.keys(temporalUnitAggregates).length;i++)controlGroups["UNIDADE TEMPORAL"][temporalUnitAggregates[i].value]=temporalUnitAggregates[i].key;for(var temporalUnitsDifferences=temporalUnits.getDifferences(),i=0;i<Object.keys(temporalUnitsDifferences).length;i++)controlGroups["CLASSIFICAÇÃO DO MAPA"][temporalUnitsDifferences[i].value]=temporalUnitsDifferences[i].key;var groupControl=L.control.groupedLayers(controlGroups,{exclusiveGroups:["UNIDADE ESPACIAL","INDICADOR","UNIDADE TEMPORAL","CLASSIFICAÇÃO DO MAPA"],collapsed:!1,position:"topleft"}).addTo(map);function setMunicipalityPanelMode(){$(".hide-in-municipality-panel").css("display","none"),$("#header-panel-title").text("Sala de Situação Municipal | "+ams.Config.appSelectedMunicipality);let param=window.location.pathname.includes("panel")?"?geocode=":"/panel?geocode=";const url=window.location.pathname.replace(/\/$/,"")+param+ams.Config.appSelectedGeocodes[0];window.history.pushState({},"",url)}if(ams.groupControl=groupControl,L.control.coordinates({position:"bottomright",decimals:2,decimalSeperator:",",enableUserInput:!1,centerUserCoordinates:!0,useLatLngOrder:!1,labelTemplateLat:"Latitude: {y}",labelTemplateLng:"Longitude: {x}"}).addTo(map),ams.Utils.handleRiskIndicator(),ams.PeriodHandler.init(map),this._addControlLayer(),map.on("changectrl",(function(evn){$("#loading_data_info").css("display","block");let changeCtrlFun=function(e){if(0==ams.App._landUseList.length&&"CATEGORIA FUNDIÁRIA"!=e.group.name&&"BIOMA"!=e.group.name)return void ams.App._resetMap("O filtro deve incluir ao menos uma categoria fundiária. A solicitação não foi concluída.");let layerToAdd,needUpdateSuLayers=!0;var startDate=ams.App._dateControl.startdate,endDate=ams.App._dateControl.enddate,tempUnit=ams.App._dateControl.period;if("BIOMA"==e.group.name){if(e.acronym==ams.Config.biome&&!1===e.subsetChanged)return;ams.App._landUseList.length!=ams.Config.landUses.length&&($(".toast").toast("show"),$(".toast-body").html("O filtro por categorias fundiárias foi restaurado ao padrão."),ams.App._landUseList=ams.Config.landUses.map(lu=>lu.id)),ams.App._suViewParams=null,ams.App._priorViewParams=null,ams.App._diffOn="onPeriod"!=ams.Config.defaultFilters.diffClassify,localStorage.setItem("ams.previous.biome.setting.selection",e.acronym),needUpdateSuLayers=!1,ams.Utils.updateMap(e.acronym,e.subset,void 0,void 0,startDate,endDate,tempUnit).then(()=>{ams.App._updateSpatialUnitLayer()})}else if("MUNICÍPIOS DE INTERESSE"==e.group.name){ams.App._landUseList.length!=ams.Config.landUses.length&&($(".toast").toast("show"),$(".toast-body").html("O filtro por categorias fundiárias foi restaurado ao padrão."),ams.App._landUseList=ams.Config.landUses.map(lu=>lu.id)),ams.App._suViewParams=null,ams.App._priorViewParams=null,ams.App._diffOn="onPeriod"!=ams.Config.defaultFilters.diffClassify;var geocodes="";"customizado"==e.name&&(geocodes=e.customized.join(",")),needUpdateSuLayers=!1,ams.Utils.updateMap("all",e.subset,e.name,geocodes,startDate,endDate,tempUnit).then(()=>{ams.App._updateSpatialUnitLayer()})}else if("INDICADOR"==e.group.name){if(ams.App._riskThreshold=0,ams.App._indicator=e.acronym,"RK"==e.acronym?(layerToAdd=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.ibamaRisk,ams.App._propertyName=ams.Config.propertyName.rk,ams.App._riskThreshold=ams.Config.defaultRiskFilter.threshold,ams.App._hasClassFilter=!1):"RI"==e.acronym?(layerToAdd=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.inpeRisk,ams.App._propertyName=ams.Config.propertyName.ri,ams.App._riskThreshold=ams.Config.defaultRiskFilter.threshold,ams.App._hasClassFilter=!1):"AF"==e.acronym?(layerToAdd=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.activeFire,ams.App._propertyName=ams.Config.propertyName.af,ams.App._hasClassFilter=!1):(layerToAdd=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.deter,ams.App._propertyName=ams.Config.propertyName.deter,ams.App._hasClassFilter=!0),ams.App._referenceLayerName!=layerToAdd?ams.App._exchangeReferenceLayer(ams.App._referenceLayerName,layerToAdd):ams.App._hasClassFilter&&ams.App._updateReferenceLayer(),ams.App._suViewParams.classname!=e.acronym){var keep_last_date=!["RI","RK","AF"].includes(e.acronym)&&!["RI","RK","AF"].includes(ams.App._suViewParams.classname);ams.App._suViewParams.classname=e.acronym,ams.App._priorViewParams.classname=e.acronym,ams.App._suViewParams.updatePropertyName(ams.App._propertyName),ams.App._priorViewParams.updatePropertyName(ams.App._propertyName),ams.App._suViewParams.updateRiskThreshold(ams.App._riskThreshold),ams.App._priorViewParams.updateRiskThreshold(ams.App._riskThreshold);let lastDateDynamic=ams.App._wfs.getLastDate(ldLayerName);lastDateDynamic=lastDateDynamic||ams.App._spatialUnits.getDefault().last_date,ams.PeriodHandler.setMaxDate(lastDateDynamic),keep_last_date&&(lastDateDynamic=ams.Date.getMin(ams.App._dateControl.startdate,lastDateDynamic)),ams.App._dateControl.setPeriod(lastDateDynamic,ams.App._currentTemporalAggregate),ams.PeriodHandler.changeDate(ams.App._dateControl.startdate),needUpdateSuLayers=!1}}else if("CATEGORIA FUNDIÁRIA"==e.group.name){let luid=+e.acronym;if("checkbox"==e.inputtype){let index=ams.App._landUseList.findIndex(v=>v==luid);e.checked&&index<0&&(ams.App._landUseList.push(luid),ams.App._resetMap()),!e.checked&&index>=0&&(ams.App._landUseList.splice(index,1),ams.App._resetMap())}needUpdateSuLayers=!1}else if("UNIDADE ESPACIAL"==e.group.name){if(ams.App._currentSULayerName!=e.acronym){let oLayerName=ams.App._getLayerPrefix();ams.App._currentSULayerName=e.acronym;let nLayerName=ams.App._getLayerPrefix();ams.App._exchangeSpatialUnitLayer(oLayerName,nLayerName),needUpdateSuLayers=!1}}else if("CLASSIFICAÇÃO DO MAPA"==e.group.name){if(ams.App._diffOn="onPeriod"!=e.acronym,ams.App._currentClassify!=e.acronym){let oLayerName=ams.App._getLayerPrefix();ams.App._currentClassify=e.acronym;let nLayerName=ams.App._getLayerPrefix();ams.App._exchangeSpatialUnitLayer(oLayerName,nLayerName),needUpdateSuLayers=!1}}else temporalUnits.isAggregate(e.name)&&(ams.App._currentTemporalAggregate=e.acronym,ams.PeriodHandler.changeDate(ams.App._dateControl.startdate),needUpdateSuLayers=!1);needUpdateSuLayers&&ams.App._updateSpatialUnitLayer(),window.setTimeout(()=>{$("#loading_data_info").css("display","none")},500)};window.setTimeout(()=>{changeCtrlFun(evn)},100)})),map.whenReady(()=>{window.setTimeout(()=>{ams.App._onWindowResize()},500)}),ams.Config.appMunicipalityPanelMode&&setMunicipalityPanelMode(),"RI"==ams.Config.defaultFilters.indicator){let obj=ams.groupControl._getControlByName("RI");$("#ctrl"+obj.ctrlId).click()}function updatePriorization(){let limit=document.getElementById("prioritization-input").value;ams.App._priorViewParams.limit=limit,ams.App._updateSpatialUnitLayer(!0)}function showErrorMsg(msg){$(".toast").toast({delay:7e3}),$(".toast-body").html(msg),$(".toast").toast("show")}$("#prioritization-input").keypress((function(e){if(13==e.which)return updatePriorization(),!1})),$("#prioritization-button").click((function(){return updatePriorization(),!1})),$('meta[name="error-msg"]').length&&(showErrorMsg($('meta[name="error-msg"]').attr("content")),$('meta[name="error-msg"]').remove());let profileClick=function(){let conf={};return conf.className=ams.App._suViewParams.classname,conf.spatialUnit=ams.Config.biome,conf.startDate=ams.App._dateControl.startdate,conf.tempUnit=ams.App._currentTemporalAggregate,"custom"===conf.tempUnit&&(conf.tempUnit=ams.App._dateControl.customDays+"d",conf.custom=!0),conf.suName=ams.Config.biome,conf.landUse=ams.App._landUseList.join(","),ams.App.displayGraph(conf),!1};$("#profile-button").click(profileClick);let landUseFilterClick=function(evn){$("#loading_data_info").css("display","block");let clickCtrlFun=function(e){0==ams.App._landUseList.length?ams.App._resetMap("O filtro deve incluir ao menos uma categoria fundiária. A solicitação não foi concluída."):(ams.App._updateSpatialUnitLayer(),ams.App._updateReferenceLayer()),window.setTimeout(()=>{$("#loading_data_info").css("display","none")},500)};return window.setTimeout(()=>{clickCtrlFun(evn)},100),!1};$("#landuse-categories-button").click(landUseFilterClick);let landUseSwapSelectionClick=function(){let ckbs=$("#ckb-itens");if(ckbs[0]){let itens=ckbs[0].getElementsByTagName("input");if(itens.length){for(let i=0;i<itens.length;i++){const iten=itens[i];iten.checked=!ams.App._landUseList.length}ams.App._landUseList=ams.App._landUseList.length?[]:ams.Config.landUses.map(lu=>lu.id)}}return ams.App._resetMap(),!1};$("#all-categories-button").click(landUseSwapSelectionClick);let landUseUpDownClick=function(elem){return"arrow_drop_down"==elem.target.innerText?(elem.target.innerText="arrow_drop_up",$("#landuse-itens")[0].style="display:flex;"):(elem.target.innerText="arrow_drop_down",$("#landuse-itens")[0].style="display:none;"),!1};$(".iconlanduse-updown").click(landUseUpDownClick),$((function(){$("#prioritization-input").dblclick(!1)})),$("#shapezip-download-button").click((function(){return ams.App._wfs.getShapeZip(ams.App._getLayerPrefix(),ams.App._suViewParams),!1})),$("#csv-download-button").click((function(){return ams.App._wfs.getCsv(ams.App._getLayerPrefix(),ams.App._priorViewParams),!1})),$("#threshold").on("change",()=>{let v=+$("#threshold").val();ams.Config.general.area.threshold=v,localStorage.setItem("ams.config.general.area.threshold",v)}),$("#changeunit").on("change",()=>{let v=$("#changeunit")[0].checked;ams.Config.general.area.changeunit=v?"auto":"no",localStorage.setItem("ams.config.general.area.changeunit",ams.Config.general.area.changeunit)}),$("#modal-credits-check").click((function(){return $("#modal-credits-check").prop("checked")?localStorage.setItem("ams.config.modal.noshowcredits",!0):localStorage.removeItem("ams.config.modal.noshowcredits"),!0})),$("#show-modal-credits").click((function(){$("#modal-container-credits").modal()})),$("#search-municipalities").on("input",(function(){const query=$(this).val().toLowerCase(),$options=$("#select-municipalities option");query.length<2&&$options.each((function(){$(this).prop("disabled",!1).show()})),$options.each((function(){const $opt=$(this),match=$opt.text().toLowerCase().includes(query);match?$opt.prop("disabled",!1).show():$opt.prop({disabled:!0}).hide()}))})),$("#select-municipalities").on("change",(function(){const $select=$(this),selected=$select.find("option:selected"),count=selected.length,maxMunicipalities=50;if($("#municipalities-search-ok").prop("disabled",0==count),$("#municipalities-search-panel").prop("disabled",1!=count),$("#select-municipalities-msg").text(count>1?`${count} municípios.`:""),count>50)for($("#select-municipalities-msg").text("Você só pode selecionar até 50 municípios.");$select.find("option:selected").length>50;){const lastSelected=$select.find("option:selected").last();lastSelected.prop("selected",!1)}})),$((function(){null!==localStorage.getItem("ams.config.general.area.changeunit")&&(ams.Config.general.area.changeunit=localStorage.getItem("ams.config.general.area.changeunit")),null!==localStorage.getItem("ams.config.general.area.threshold")&&(ams.Config.general.area.threshold=localStorage.getItem("ams.config.general.area.threshold")),$("#threshold").val(ams.Config.general.area.threshold),$("#changeunit")[0].checked="auto"==ams.Config.general.area.changeunit,null==localStorage.getItem("ams.config.modal.noshowcredits")&&$("#modal-container-credits").modal(),ams.App._populateMunicipalities()}))},_setIndicator:function(indicator){console.log("setting indicator "+indicator),ams.App._indicator=indicator,"AF"==indicator?(ams.App._propertyName=ams.Config.propertyName.af,ams.App._referenceLayerName=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.activeFire,ams.App._hasClassFilter=!1):"RK"==indicator?(ams.App._propertyName=ams.Config.propertyName.rk,ams.App._referenceLayerName=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.ibamaRisk,ams.App._hasClassFilter=!1,ams.App._diffOn=!1):"RI"==indicator?(ams.App._propertyName=ams.Config.propertyName.ri,ams.App._referenceLayerName=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.inpeRisk,ams.App._hasClassFilter=!1,ams.App._diffOn=!1):(ams.App._propertyName=ams.Config.propertyName.deter,ams.App._referenceLayerName=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.deter,ams.App._hasClassFilter=!0),ams.App._currentClassify=ams.Config.defaultFilters.diffClassify},_populateMunicipalities:function(){const $selectMunicipalities=$("#select-municipalities");$selectMunicipalities.empty(),$.each(ams.Config.appAllMunicipalities,(function(index,municipality){const option=$("<option></option>").val(municipality.geocode).text(municipality.name);$selectMunicipalities.append(option)}))},_getCustomizedMunicipalities:function(){const modal=$("#modal-container-municipalities");function _closeCustomizedMunicipalities(){modal.modal("hide"),$("#search-municipalities").val(""),$("#select-municipalities option").show(),$("#select-municipalities option").prop("selected",!1),$("#municipalities-search-ok").prop("disabled",!0),$("#municipalities-search-panel").prop("disabled",!0),$("#select-municipalities-msg").text("")}return new Promise(resolve=>{modal.modal("show"),$("#municipalities-search-ok").off("click").on("click",(function(){const geocodes=$("#select-municipalities option:selected").map((function(){return $(this).val()})).get();_closeCustomizedMunicipalities(),resolve(geocodes)})),$("#municipalities-search-panel").off("click").on("click",(function(){const geocodes=$("#select-municipalities option:selected").map((function(){return $(this).val()})).get();_closeCustomizedMunicipalities(),resolve([]),ams.App.startMunicipalityPanel("geocode",geocodes[0])})),$("#municipalities-search-cancel").off("click").on("click",(function(){_closeCustomizedMunicipalities(),resolve([])})),$("#municipalities-search-close").off("click").on("click",(function(){_closeCustomizedMunicipalities(),resolve([])}))})},_updateReferenceLayer:function(){let l=this._getLayerByName(this._referenceLayerName);if(l){let cqlobj={};if(!this._referenceLayerName.includes(ams.Config.defaultLayers.ibamaRisk)&&!this._referenceLayerName.includes(ams.Config.defaultLayers.inpeRisk)){let cql=ams.App._appClassGroups.getCqlFilter(ams.App._suViewParams,this._hasClassFilter);l._source.options.cql_filter=cql,cqlobj={cql_filter:cql}}cqlobj.viewparams="landuse:"+ams.App._landUseList.join("\\,")+";biomes:"+ams.App._biomes.join("\\,")+";municipality_group_name:"+ams.App._municipalitiesGroup+";geocodes:"+ams.App._geocodes.join("\\,"),this._addWmsOptionsBase(cqlobj),l._source._overlay.setParams(cqlobj),this._map.hasLayer(l)||l.addTo(this._map),l.bringToBack()}$("#dataname-to-download").text(ams.App._appClassGroups.getGroupName(ams.App._suViewParams.classname))},_updateSpatialUnitLayer:function(onlyPriority){this._map.closePopup(),onlyPriority=void 0!==onlyPriority&&onlyPriority;let l=null,mm=this._getMinMax(this._getLayerPrefix(),this._propertyName);if(mm){if(!onlyPriority&&(l=this._getLayerByName(this._getLayerPrefix()),l&&this._map.hasLayer(l))){let suLayerStyle=new ams.SLDStyles.AreaStyle(this._getLayerPrefix(),this._propertyName,mm.suLayerMin,mm.suLayerMax),wmsOptions={opacity:.8,viewparams:this._suViewParams.toWmsFormat(),sld_body:suLayerStyle.getSLD()};this._addWmsOptionsBase(wmsOptions),l._source._overlay.setParams(wmsOptions),Object.assign(l.options,wmsOptions),Object.assign(l._source.options,wmsOptions),l.bringToFront(),this._legendControl.update(this._getLayerPrefix(),suLayerStyle)}if(l=this._getLayerByName(this._getLayerPrefix()+"_prior"),l&&this._map.hasLayer(l)){let priorLayerStyle=new ams.SLDStyles.AreaStyle(this._getLayerPrefix(),this._propertyName,mm.suLayerMin,mm.suLayerMax,!0,"#ff0000"),wmsOptions={viewparams:this._priorViewParams.toWmsFormat(),sld_body:priorLayerStyle.getSLD()};this._addWmsOptionsBase(wmsOptions),l._source._overlay.setParams(wmsOptions),Object.assign(l.options,wmsOptions),Object.assign(l._source.options,wmsOptions),l.bringToFront()}}},_addWmsOptionsBase:function(options){let wmsOptionsBase={transparent:!0,tiled:!0,format:"image/png"};for(let k in wmsOptionsBase)options[k]=wmsOptionsBase[k]},_addControlLayer:function(){ams.App._layerControl&&ams.App._map.removeControl(ams.App._layerControl);let bs={OpenStreetMap:ams.App._baseLayers.osm,"Google Satélite":ams.App._baseLayers.gs,"Google Híbrido":ams.App._baseLayers.gh,"Google Ruas":ams.App._baseLayers.gst,"Google Terreno":ams.App._baseLayers.gte,"Em branco":ams.App._baseLayers.blank},ol={};for(let ll in ams.App._addedLayers){let lname=ll.includes("deter")?"DETER":ll.includes("fire")?"Focos":ll.includes("ibama")?"Risco (IBAMA)":!!ll.includes("inpe")&&"Risco (INPE)";ams.App._map.hasLayer(ams.App._addedLayers[ll])&&!1!==lname&&(ol[lname]=ams.App._addedLayers[ll])}ams.App._borderLayer&&(ol[ams.Config.biome]=ams.App._borderLayer),ams.App._layerControl=L.control.layers(bs,ol).addTo(ams.App._map)},_exchangeReferenceLayer:function(layerToDel,layerToAdd){ams.App._removeLayer(layerToDel),this._referenceLayerName=layerToAdd;let layer=this._getLayerByName(layerToAdd),cqlobj={};if(layer){if(!layerToAdd.includes(ams.Config.defaultLayers.ibamaRisk)&&!layerToAdd.includes(ams.Config.defaultLayers.inpeRisk)){let cql=this._appClassGroups.getCqlFilter(this._suViewParams,this._hasClassFilter);layer._source.options.cql_filter=cql,cqlobj={cql_filter:cql,viewparams:"landuse:"+ams.App._landUseList.join("\\,")},this._addWmsOptionsBase(cqlobj)}layer._source._overlay.setParams(cqlobj),layer.addTo(this._map),layer.bringToBack()}this._addControlLayer()},_addSpatialUnitLayer:function(layerName,propertyName){let l1=this._getLayerByName(layerName),l2=this._getLayerByName(layerName+"_prior");l1&&delete this._addedLayers[layerName],l2&&delete this._addedLayers[layerName+"_prior"];let mm=this._getMinMax(layerName,propertyName);if(!mm)return;let layer=this._createSULayer(layerName,propertyName,mm);layer.addTo(this._map),layer=this._createPriorSULayer(layerName,propertyName,mm),layer.addTo(this._map),layer.bringToFront()},_getWmsOptions:function(layerName,propertyName,minMax,viewParams,isPriority){let s=(isPriority=void 0!==isPriority&&isPriority)?new ams.SLDStyles.AreaStyle(layerName,propertyName,minMax.suLayerMin,minMax.suLayerMax,!0,"#ff0000"):new ams.SLDStyles.AreaStyle(layerName,propertyName,minMax.suLayerMin,minMax.suLayerMax);isPriority||this._legendControl.init(layerName,s);let wmsOptions={viewparams:viewParams.toWmsFormat(),sld_body:s.getSLD()};return isPriority?wmsOptions.identify=!1:wmsOptions.opacity=.8,this._addWmsOptionsBase(wmsOptions),wmsOptions},_createSULayer:function(layerName,propertyName,minMax){let wop=this._getWmsOptions(layerName,propertyName,minMax,this._suViewParams),sl=new ams.LeafletWms.Source(this._baseURL,wop,this._appClassGroups);return layer=sl.getLayer(layerName),this._addedLayers[layerName]=layer,layer},_createPriorSULayer:function(layerName,propertyName,minMax){let wop=this._getWmsOptions(layerName,propertyName,minMax,this._priorViewParams,!0),sl=new ams.LeafletWms.Source(this._baseURL,wop,this._appClassGroups);return layer=sl.getLayer(layerName),this._addedLayers[layerName+"_prior"]=layer,layer},_getLayerByName:function(layerName){return void 0!==this._addedLayers[layerName]&&this._addedLayers[layerName]},_getLayerPrefix:function(){return this._currentSULayerName+("onPeriod"==this._currentClassify?"_view":"_diff_view")},hasSpatialUnitLayer:function(){return this._addedLayers.hasOwnProperty(ams.App._getLayerPrefix())},addSpatialUnitLayer:function(){this._addSpatialUnitLayer(this._getLayerPrefix(),this._propertyName)},_getMinMax:function(layerName,propertyName){let min,max,mm={suLayerMin:ams.App._diffOn?ams.App._wfs.getMin(layerName,propertyName,ams.App._suViewParams):0,suLayerMax:ams.App._wfs.getMax(layerName,propertyName,ams.App._suViewParams)};if(mm.suLayerMax==mm.suLayerMin){let landUse="";0==ams.App._landUseList.length&&(landUse="<br /><br /><b>Atenção</b>: Deve selecionar ao menos um item no filtro por categorias fundiárias.");let msg=ams.App._indicator.includes("RI")?"Não existem dados de risco.":"Não existem dados para o período selecionado."+landUse;return this._resetMap(msg),!1}if(ams.App._diffOn&&mm.suLayerMin>=0)return this._resetMap("Não há redução de valores para o período selecionado."),!1;let l=ams.App._getLayerByName(ams.App._getLayerPrefix());return l&&!ams.App._map.hasLayer(l)&&ams.App._addSpatialUnitLayer(ams.App._getLayerPrefix(),ams.App._propertyName),mm},_resetMap:function(toast_msg){void 0!==toast_msg&&($(".toast").toast("show"),$(".toast-body").html(toast_msg));let oLayerName=ams.App._getLayerPrefix();this._removeLayer(oLayerName),this._removeLayer(oLayerName+"_prior"),ams.App._legendControl.disable(),ams.App._removeLayer(ams.App._referenceLayerName)},_exchangeSpatialUnitLayer:function(lr,li){this._removeLayer(lr),this._removeLayer(lr+"_prior"),ams.App._addSpatialUnitLayer(li,this._propertyName)},_removeLayer:function(layerName){let l=ams.App._getLayerByName(layerName);l&&this._map.hasLayer(l)&&this._removeSubLayer(l),this._map.closePopup()},_removeSubLayer:function(l){let ll=[];for(ll.push(l._leaflet_id),ll.push(l._source._leaflet_id),ll.push(l._source._overlay._leaflet_id);ll.length;){let lid=ll.pop(),lm=this._map._layers[lid];lm&&(void 0===lm.onRemove?delete this._map._layers[lid]:this._map.hasLayer(lm)&&this._map.removeLayer(lm))}},_onWindowResize:function(){ams.groupControl._onWindowResize()},displayGraph:function(jsConfig){async function getGraphics(jsConfig){jsConfig.unit=ams.Map.PopupControl._unit,jsConfig.targetbiome=ams.Config.biome,jsConfig.riskThreshold=ams.App._suViewParams.risk_threshold,jsConfig.municipalitiesGroup=ams.App._municipalitiesGroup,jsConfig.geocodes=ams.App._geocodes.join(",");let jsConfigStr=JSON.stringify(jsConfig),response=await fetch("callback/spatial_unit_profile?sData="+jsConfigStr).catch(()=>{console.log("The backend service may be offline or your internet connection has been interrupted.")});if($("#loading_data_info").css("display","none"),response&&response.ok){let profileJson=await response.json();Plotly.purge("AreaPerYearTableClass"),profileJson.AreaPerYearTableClass&&Plotly.react("AreaPerYearTableClass",JSON.parse(profileJson.AreaPerYearTableClass),{}),Plotly.purge("AreaPerLandUse"),profileJson.AreaPerLandUse&&ams.App._landUseList.length>1&&Plotly.react("AreaPerLandUse",JSON.parse(profileJson.AreaPerLandUse),{}),Plotly.purge("AreaPerLandUsePpcdam"),profileJson.AreaPerLandUsePpcdam&&ams.App._landUseList.length>1&&Plotly.react("AreaPerLandUsePpcdam",JSON.parse(profileJson.AreaPerLandUsePpcdam),{}),document.getElementById("txt3a").innerHTML=profileJson.FormTitle,$("#modal-container-general-info").modal()}else{let emsg="";emsg=response?"HTTP-Error: "+response.status+" on spatial_unit_profile":"O servidor está indisponível ou sua internet está desligada.",console.log(emsg),$(".toast").toast("show"),$(".toast-body").html("Encontrou um erro na solicitação ao servidor.<br />"+emsg)}}"null"!=jsConfig.className&&(ams.App._landUseList.length>0?($("#loading_data_info").css("display","block"),getGraphics(jsConfig)):ams.App._resetMap("O filtro deve incluir ao menos uma categoria fundiária. A solicitação não foi concluída."))},saveAlerts:function(jsConfig){async function _saveAlerts(jsConfig){$("#loading_data_info").css("display","block");let layerName=ams.App._getLayerPrefix();layerName=ams.App._spatialUnits.find(layerName.substring(layerName.indexOf(":")+1).replace("_view","")),layerName=layerName?layerName.description:baseName,layerName=layerName.replaceAll(" ","_");let dataName=ams.App._appClassGroups.getGroupName(ams.App._suViewParams.classname);dataName=dataName||viewParams.classname,dataName=dataName.replaceAll(" ","_");let sdt=ams.PeriodHandler._startdate.toLocaleDateString().replaceAll("/","-"),edt=ams.PeriodHandler._enddate.toLocaleDateString().replaceAll("/","-"),filenamePrefix=ams.Config.biome+"_"+layerName+"-"+jsConfig.suName+"_"+dataName+"_"+edt+"_"+sdt;jsConfig.targetbiome=ams.Config.biome,jsConfig.isAuthenticated=ams.Auth.isAuthenticated(),jsConfig.filenamePrefix=filenamePrefix;let jsConfigStr=JSON.stringify(jsConfig),response=await fetch("alerts?sData="+jsConfigStr).catch(()=>{console.log("The backend service may be offline or your internet connection has been interrupted.")});if($("#loading_data_info").css("display","none"),response&&response.ok){const blob=await response.blob(),url=window.URL.createObjectURL(blob),link=document.createElement("a");link.href=url,link.download=filenamePrefix+".zip",link.click(),window.URL.revokeObjectURL(url)}else{let emsg="";emsg=response?"HTTP-Error: "+response.status+" on spatial_unit_profile":"O servidor está indisponível ou sua internet está desligada.",console.log(emsg),$(".toast").toast("show"),$(".toast-body").html("Encontrou um erro na solicitação ao servidor.<br />"+emsg)}}_saveAlerts(jsConfig)},startMunicipalityPanel:function(name,value){async function _startMunicipalityPanel(name,value){let startDate=ams.App._dateControl.startdate,endDate=ams.App._dateControl.enddate,tempUnit=ams.App._dateControl.period,response=await fetch("panel?"+name+"="+value+"&startDate="+(void 0!==startDate?startDate:"")+"&endDate="+(void 0!==endDate?endDate:"")+"&tempUnit="+(void 0!==tempUnit?tempUnit:"")+"&classname="+ams.App._suViewParams.classname).catch(()=>{console.log("The backend service may be offline or your internet connection has been interrupted.")});if(response&&response.ok){const html=await response.text(),newWindow=window.open("","_blank");if(!newWindow)return void window.alert("Não foi possível abrir a nova janela. Verifique o bloqueador de pop-ups.");newWindow.document.write(html),newWindow.document.close()}else{let emsg="";emsg=response?"HTTP-Error: "+response.status:"O servidor está indisponível ou sua internet está desligada.",console.log(emsg),$(".toast").toast("show"),$(".toast-body").html("Encontrou um erro na solicitação ao servidor.<br />"+emsg)}}_startMunicipalityPanel(name,value)}};