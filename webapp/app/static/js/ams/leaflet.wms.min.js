var ams=ams||{};ams.LeafletWms={Source:L.WMS.Source.extend({initialize:function(url,options,deterClassGroups){L.setOptions(this,options),this.options.tiled&&(this.options.untiled=!1),this._url=url,this._subLayers={},this._overlay=this.createOverlay(this.options.untiled),this._deterClassGroups=deterClassGroups},showFeatureInfo:function(latlng,jsonTxt){if(jsonTxt.includes("no features were found"))return $(".toast").toast("show"),void $(".toast-body").html("Sem informações para este local.");let featureInfo=JSON.parse(jsonTxt),htmlInfo="",name="",type="";if(featureInfo.numberReturned>=1&&(this._isDeterInfo()?(name="DETER",type="deter",htmlInfo=this._formatDeterPopup(featureInfo)):this._isAFInfo()?(name="Queimadas",type="af",htmlInfo=this._formatAFPopup(featureInfo)):this._isRKInfo()?(name="Risco de Desmatamento",type="risk",htmlInfo=this._formatRiskPopup(featureInfo)):(name="Unidade Espacial",type="su",htmlInfo=this._formatSpatialUnitPopup(featureInfo)),""!=type&&""!=name&&""!=htmlInfo)){ams.Map.PopupControl._infoBody.push({type:type,name:name,htmlInfo:htmlInfo});let htmlPopup=this._accordionFormat();ams.Map.PopupControl._popupReference&&ams.Map.PopupControl._popupReference._popup?ams.Map.PopupControl._popupReference._popup.setContent(htmlPopup):(ams.Map.PopupControl._popupReference=this._map.openPopup(htmlPopup,latlng),ams.Map.PopupControl._popupReference.on("popupclose",()=>{ams.Map.PopupControl._infoBody=[]}))}},_accordionFormat:function(){let ac='<div id="accordion">';for(let id in ams.Map.PopupControl._infoBody){let body=ams.Map.PopupControl._infoBody[id];ac=ac+'<div class="card">    <div class="card-header">    <a class="'+("su"==body.type?"":"collapsed ")+'card-link" data-toggle="collapse" href="#collapse'+id+'">        '+body.name+'    </a>    </div>    <div id="collapse'+id+'" class="collapse'+("su"==body.type?" show":"")+'" data-parent="#accordion">    <div class="card-body">        '+body.htmlInfo+"    </div>    </div></div>"}return ac+="</div>",ac},_isDeterInfo:function(){return this._overlay.wmsParams.layers.includes(ams.Config.defaultLayers.deter)},_isAFInfo:function(){return this._overlay.wmsParams.layers.includes(ams.Config.defaultLayers.activeFire)},_isRKInfo:function(){return this._overlay.wmsParams.layers.includes(ams.Config.defaultLayers.ibamaRisk)},_updateResults:function(result,featureInfo){let fProperties=featureInfo.features[0].properties;for(let i in fProperties){let v=null==fProperties[i]||""==fProperties[i]?"-":fProperties[i];i in result&&("area"==i&&"ha"==ams.Map.PopupControl._unit&&(v*=100,result.area_unit=ams.Map.PopupControl._unit),result[i]=isNaN(v)?v:ams.Utils.numberFormat(v))}},_formatSpatialUnitPopup:function(featureInfo){let result={name:"",classname:"",area:0,counts:0,percentage:0,area_unit:"km²",suid:""};this._updateResults(result,featureInfo);let buttons=this._createButtons(result);return this._createSpatialUnitInfoTable(result)+buttons},_formatClassName:function(acronym){return"null"!=acronym?this._deterClassGroups.getGroupName(acronym):" "},_getViewConfig:function(suName){let n=suName.replace(/ /g,"|"),conf={};return conf.className=ams.App._suViewParams.classname,conf.spatialUnit=ams.App._currentSULayerName.split(":")[1],conf.startDate=ams.App._dateControl.startdate,conf.tempUnit=ams.App._currentTemporalAggregate,"custom"===conf.tempUnit&&(conf.tempUnit=ams.App._dateControl.customDays+"d",conf.custom=!0),conf.suName=n,conf.landUse=ams.App._landUseList.join(","),conf.targetbiome=ams.Config.biome,conf.municipalitiesGroup=ams.App._municipalitiesGroup,conf.geocodes=ams.App._geocodes.join(","),conf},_createButtons:function(result){let suName=result.name,suId=result.suid,area=result.area,classname=result.classname,viewConfig=this._getViewConfig(suName),buttons='<div class="button-container">';return 0!=area&&(buttons+='<button class="btn btn-primary-p btn-success" style="margin:1px" onclick=ams.App.displayGraph('+JSON.stringify(viewConfig)+")>Perfil</button>",["DS","DG","CS","MN"].includes(classname)&&(buttons+='<button class="btn btn-primary-p btn-success" style="margin:1px" onclick=ams.App.saveAlerts('+JSON.stringify(viewConfig)+")>Salvar alertas</button>")),ams.App._currentSULayerName.includes("municipalities")&&void 0===ams.Utils.getServerConfigParam("municipality-panel")&&(buttons+='<button class="btn btn-primary-p btn-success" style="margin:1px" onclick=ams.App.startMunicipalityPanel("id",'+suId+")>Sala de Situa&ccedil;&atilde;o Municipal</button>"),buttons+="</div>",buttons},_createSpatialUnitInfoTable:function(result){let risk=focus=deter="";return"AF"==result.classname?focus="<tr><td>Focos (unidades)   </td><td>"+result.counts+"</td></tr>":"RK"==result.classname?risk="<tr><td>Riscos (unidades)   </td><td>"+result.counts+"</td></tr>":deter="<tr><td>&#193;rea ("+result.area_unit+")</td><td>"+result.area+"</td></tr><tr><td>Porcentagem   </td><td>"+result.percentage+"%</td></tr>","<table class=\"popup-spatial-unit-table\"><tr><th>Nome</th><th>Valor</th></tr><tr><td>Unidade Espacial   </td><td style='text-align-last: center;'>"+result.name+"</td></tr><tr><td>Classe   </td><td>"+this._formatClassName(result.classname)+"</td></tr>"+risk+focus+deter+"</table>"},_formatRiskPopup:function(featureInfo){let result={id:0,risk:0,risk_date:""};return this._updateResults(result,featureInfo),this._createRiskInfoTable(result)},_createRiskInfoTable:function(result){let table='<table class="popup-deter-table" style="width:100%"><tr><th></th><th></th></tr>';for(let k in result){let v=result[k];k.includes("date")&&(v=this._formatDate(v)),table+="<tr><td>"+k+"  </td><td>"+("null"!=v?v:" ")+"</td></tr>"}return table+="</table>",table},_formatAFPopup:function(featureInfo){let result={diasemchuva:0,estado:"",municipio:"",precipitacao:0,riscofogo:0,satelite:"",view_date:""};return this._updateResults(result,featureInfo),this._createAFInfoTable(result)},_createAFInfoTable:function(result){let table='<table class="popup-deter-table" style="width:100%"><tr><th></th><th></th></tr>';for(let k in result){let v=result[k];k.includes("view_date")&&(v=this._formatDate(v)),table+="<tr><td>"+k+"  </td><td>"+("null"!=v?v:" ")+"</td></tr>"}return table+="<tr><td colspan='2'><a target='_blank' href='"+ams.Config.AFMetadataURL+"'>Ver detalhes dos atributos</a></td></tr>",table+="</table>",table},_formatDeterPopup:function(featureInfo){let result={classname:"",view_date:"",areamunkm:0,areatotalkm:0,areauckm:0,municipality:"",uc:null,uf:"",biome:""};return this._updateResults(result,featureInfo),this._createDeterInfoTable(result)},_createDeterInfoTable:function(result){let table='<table class="popup-deter-table" style="width:100%"><tr><th></th><th></th></tr>';for(let k in result){let v=result[k];k.includes("view_date")&&(v=this._formatDate(v)),k.includes("car_imovel")&&v.split(";").length>=1?table+="<tr><td colspan='2'>"+k+("null"!=v?this._formatListCAR(v):" ")+"</td></tr>":table+="<tr><td>"+k+"  </td><td>"+("null"!=v?v:" ")+"</td></tr>"}return table+="<tr><td colspan='2'><a target='_blank' href='"+ams.Config.DETERMetadataURL+"'>Ver detalhes dos atributos</a></td></tr>",table+="</table>",table},_formatDate:function(str){let res=str.replace("Z","").split("-");return`${res[2]}/${res[1]}/${res[0]}`},_formatListCAR:function(str){let ids;return"<div id='ids_car'><textarea name='listcars' rows='2' cols='40' readonly style='resize: none;max-width: fit-content;border:0;font-size:xx-small;'>"+str.replaceAll(";","\n")+"</textarea></div>"}})};