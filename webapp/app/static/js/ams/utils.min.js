var ams=ams||{};ams.Utils={tid:null,isHomologationEnvironment:function(){return window.location.pathname.includes("homologation")||"127.0.0.1"==window.location.hostname},setMapHeight:function(){$("#map").height(window.innerHeight-$("footer.footer").height()-$("#content").height())},onWindowResize:function(){ams.Utils.tid&&window.clearTimeout(ams.Utils.tid),ams.Utils.tid=window.setTimeout(()=>{ams.Utils.tid=null,ams.Utils.setMapHeight(),ams.App._onWindowResize()},200)},getServerConfigParam:function(param){return $('meta[name="'+param+'"]').attr("content")},getGeneralConfig:function(){let generalConfig=localStorage.getItem("ams.session.generalConfig");if(null!==generalConfig)return JSON.parse(generalConfig)},startApp:function(generalConfig){if(localStorage.setItem("ams.session.status",ams.Auth.isAuthenticated()),void 0!==generalConfig){ams.Auth.evaluate(),ams.Utils.setMapHeight();var biome=generalConfig.appBiome.split(",")[0];ams.Config=ams.BiomeConfig[biome],ams.Config.allBiomes=JSON.parse(generalConfig.biomes.replace(/'/g,'"')),ams.Config.allMunicipalitiesGroup=JSON.parse(generalConfig.municipalities_group.replace(/'/g,'"')),ams.Config.allStates=JSON.parse(generalConfig.states_group.replace(/'/g,'"')),ams.Config.landUses=JSON.parse(generalConfig.land_uses.replace(/'/g,'"')),ams.Config.biome=generalConfig.appBiome,ams.Config.appSelectedSubset=generalConfig.selected_subset,ams.Config.appSelectedBiomes=JSON.parse(generalConfig.selected_biomes.replace(/'/g,'"')),ams.Config.appSelectedMunicipalitiesGroup=generalConfig.selected_municipalities_group,ams.Config.appSelectedGroup=generalConfig.selected_municipalities_group,ams.Config.bbox=JSON.parse(generalConfig.bbox),ams.Config.appSelectedGeocodes=JSON.parse(generalConfig.selected_geocodes),ams.Config.appAllMunicipalities=JSON.parse(generalConfig.all_municipalities.replace(/'/g,'"')),ams.Config.appMunicipalityPanelMode=JSON.parse(generalConfig.municipality_panel_mode),ams.Config.appSelectedMunicipality=generalConfig.selected_municipality,ams.Config.startDate=generalConfig.start_date,ams.Config.endDate=generalConfig.end_date,ams.Config.tempUnit=generalConfig.temp_unit;var classGroups=JSON.parse(generalConfig.deter_class_groups.replace(/'/g,'"'));generalConfig.classname?ams.Config.defaultFilters.indicator=generalConfig.classname:ams.Config.defaultFilters.indicator=classGroups[0].name;var spatialUnits=JSON.parse(generalConfig.spatial_units_info_for_subset.replace(/'/g,'"')),spatialUnitsSubset=new ams.Map.SpatialUnits(spatialUnits,spatialUnits[0].dataname),appClassGroups=new ams.Map.AppClassGroups(JSON.parse(generalConfig.deter_class_groups.replace(/'/g,'"'))),geoserverUrl=generalConfig.geoserver_url;try{ams.App.run(geoserverUrl,spatialUnitsSubset,appClassGroups)}catch(error){console.log(error),ams.Utils.resetlocalStorage()}}else ams.Utils.updateMap()},handleRiskIndicator:function(){var show=ams.Auth.isAuthenticated();$("#leaflet-control-layers-group-1 label span").each((function(){if(-1!==$(this).text().toLowerCase().indexOf("risco de des"))return show?$(this).closest("label").show():$(this).closest("label").hide(),!1}))},restartApp:function(resetMap=!1){ams.Utils.handleRiskIndicator();var status=localStorage.getItem("ams.session.status");if(resetMap||!ams.Auth.isAuthenticated()||null==status||"true"!=status.toLowerCase()){Authentication.eraseCookie(Authentication.tokenKey);var mapDiv=$("#map");mapDiv&&(mapDiv.remove(),$("#panel_container").append("<div id='map'>")),ams.Utils.setMapHeight(),ams.Utils.startApp()}},updateMap:function(selectedBiome,selectedSubset,selectedMunicipalitiesGroup,selectedGeocodes,startDate,endDate,tempUnit){void 0===selectedBiome&&(selectedBiome=ams.defaultBiome),void 0===selectedSubset&&(selectedSubset=ams.defaultSubset),void 0===selectedMunicipalitiesGroup&&(selectedMunicipalitiesGroup=ams.defaultMunicipalitiesGroup),void 0===selectedGeocodes&&(selectedGeocodes="");var municipalityPanelMode=!1,classname="";void 0!==ams.Utils.getServerConfigParam("municipality-panel")&&(municipalityPanelMode=!0,selectedBiome="ALL",selectedSubset="Municípios de Interesse",selectedMunicipalitiesGroup="customizado",selectedGeocodes=ams.Utils.getServerConfigParam("geocode"),startDate=ams.Utils.getServerConfigParam("start_date"),endDate=ams.Utils.getServerConfigParam("end_date"),tempUnit=ams.Utils.getServerConfigParam("temp_unit"),classname=ams.Utils.getServerConfigParam("classname")),void 0===startDate&&(startDate=""),void 0===endDate&&(endDate=""),void 0!==tempUnit&&tempUnit.length||(tempUnit=ams.BiomeConfig[selectedBiome].defaultFilters.temporalUnit),classname.length||(classname=ams.BiomeConfig[selectedBiome].defaultFilters.indicator);const loadConfig=new Promise((resolve,reject)=>{async function getConfig(selectedBiome,selectedSubset,selectedMunicipalitiesGroup,selectedGeocodes,municipalityPanelMode){let response=await fetch("biome/config?targetbiome="+selectedBiome+"&subset="+selectedSubset+"&municipalitiesGroup="+selectedMunicipalitiesGroup+"&isAuthenticated="+ams.Auth.isAuthenticated()+"&geocodes="+selectedGeocodes+"&municipalityPanelMode="+municipalityPanelMode+"&startDate="+(void 0!==startDate?startDate:"")+"&endDate="+(void 0!==endDate?endDate:"")+"&tempUnit="+(void 0!==tempUnit?tempUnit:"")+"&classname="+classname);if(response&&response.ok){let generalConfig=await response.json();generalConfig.appBiome?(localStorage.setItem("ams.session.generalConfig",JSON.stringify(generalConfig)),ams.Utils.startApp(generalConfig),resolve()):(ams.Notifier.showErrorMsg(msg=ams.Notifier.Errors.REQUEST_FAILED,response=response,desc="on biome changes"),reject("HTTP-Error: "+response.status+" on biome changes"))}else{let error_msg=ams.Notifier.Errors.REQUEST_FAILED,text;error_msg=error_msg+" "+await response.text(),ams.Notifier.showErrorMsg(msg=error_msg,response=response,desc="on biome changes"),reject("HTTP-Error: "+response.status+" on biome changes")}}delete ams.Map.PopupControl._popupReference,ams.Map.PopupControl._infoBody=[];let mapDiv=$("#map");mapDiv&&(mapDiv.remove(),$("#panel_container").append("<div id='map'>")),ams.Utils.setMapHeight(),ams.Auth.resetWorkspace(),getConfig(selectedBiome,selectedSubset,selectedMunicipalitiesGroup,selectedGeocodes,municipalityPanelMode)});return loadConfig},numberFormat:function(n){let sp;return 2==(n+="").split(".").length?parseFloat(n).toFixed(ams.Config.floatDecimals):parseInt(n)},resetlocalStorage:function(){localStorage.clear()},assert:function(condition,msg){if(!condition)throw new Error(msg||"assertion error")}},ams.Notifier={Errors:{REQUEST_FAILED:"Encontrou um erro na solicitação ao servidor."},showErrorMsg:function(msg,response,desc){error_msg="",response&&console.log("HTTP-Error: "+response.status+" "+desc),$(".toast").toast({delay:7e3}),$(".toast-body").html(msg),$(".toast").toast("show")},showMsg:function(msg){$(".toast").toast({delay:7e3}),$(".toast-body").html(msg),$(".toast").toast("show")},showErrorIfExists:function(){$('meta[name="error-msg"]').length&&(ams.Notifier.showErrorMsg($('meta[name="error-msg"]').attr("content")),$('meta[name="error-msg"]').remove())}};