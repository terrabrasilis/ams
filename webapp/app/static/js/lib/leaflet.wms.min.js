/*!
 * leaflet.wms.js
 * A collection of Leaflet utilities for working with Web Mapping services.
 * (c) 2014-2016, Houston Engineering, Inc.
 * MIT License
 */
!function(factory){if("function"==typeof define&&define.amd)define(["leaflet"],factory);else if("undefined"!=typeof module)module.exports=factory(require("leaflet"));else{if(void 0===this.L)throw"Leaflet must be loaded first!";this.L.WMS=this.L.wms=factory(this.L)}}((function(L){var wms={};async function fetchImage(url,callback,headers,abort){let _headers={};headers&&headers.forEach(h=>{_headers[h.header]=h.value});const controller=new AbortController,signal=controller.signal;abort&&abort.subscribe(()=>{controller.abort()});const f=await fetch(url,{method:"GET",headers:_headers,mode:"cors",signal:signal,credentials:"omit",cache:"no-cache"}),blob=await f.blob();callback(blob)}"keys"in Object||(Object.keys=function(obj){var result=[];for(var i in obj)obj.hasOwnProperty(i)&&result.push(i);return result}),wms.Source=L.Layer.extend({options:{untiled:!0,identify:!0},initialize:function(url,options){L.setOptions(this,options),this.options.tiled&&(this.options.untiled=!1),this._url=url,this._subLayers={},this._overlay=this.createOverlay(this.options.untiled)},createOverlay:function(untiled){var overlayOptions={};for(var opt in this.options)"untiled"!=opt&&"identify"!=opt&&(overlayOptions[opt]=this.options[opt]);return untiled?wms.overlay(this._url,overlayOptions):wms.wmsHeader(this._url,overlayOptions)},onAdd:function(){this.refreshOverlay()},getEvents:function(){return this.options.identify?{click:this.identify}:{}},setOpacity:function(opacity){this.options.opacity=opacity,this._overlay&&this._overlay.setOpacity(opacity)},bringToBack:function(){this.options.isBack=!0,this._overlay&&this._overlay.bringToBack()},bringToFront:function(){this.options.isBack=!1,this._overlay&&this._overlay.bringToFront()},getLayer:function(name){return wms.layer(this,name)},addSubLayer:function(name){this._subLayers[name]=!0,this.refreshOverlay()},removeSubLayer:function(name){delete this._subLayers[name],this.refreshOverlay()},refreshOverlay:function(){var subLayers=Object.keys(this._subLayers).join(",");this._map&&(subLayers?(this._overlay.setParams({layers:subLayers}),this._overlay.addTo(this._map)):this._overlay.remove())},identify:function(evt){var layers=this.getIdentifyLayers();layers.length&&this.getFeatureInfo(evt.containerPoint,evt.latlng,layers,this.showFeatureInfo)},getFeatureInfo:function(point,latlng,layers,callback){let params=this.getFeatureInfoParams(point,layers);params.info_format="application/json";let url=this._url+L.Util.getParamString(params,this._url);function done(result){this.hideWaiting();var text=this.parseFeatureInfo(result,url);callback.call(this,latlng,text)}this.showWaiting(),this.ajax(url,done)},ajax:function(url,callback){ajax.call(this,url,callback)},getIdentifyLayers:function(){return this.options.identifyLayers?this.options.identifyLayers:Object.keys(this._subLayers)},getFeatureInfoParams:function(point,layers){var wmsParams,overlay;this.options.untiled?wmsParams=this._overlay.wmsParams:((overlay=this.createOverlay(!0)).updateWmsParams(this._map),(wmsParams=overlay.wmsParams).layers=layers.join(","));var infoParams={request:"GetFeatureInfo",query_layers:layers.join(","),X:Math.round(point.x),Y:Math.round(point.y)};return L.extend({},wmsParams,infoParams)},parseFeatureInfo:function(result,url){return"error"==result&&(result="<iframe src='"+url+"' style='border:none'>"),result},showFeatureInfo:function(latlng,info){this._map&&this._map.openPopup(info,latlng)},showWaiting:function(){this._map&&(this._map._container.style.cursor="progress")},hideWaiting:function(){this._map&&(this._map._container.style.cursor="default")}}),wms.source=function(url,options){return new wms.Source(url,options)},wms.Layer=L.Layer.extend({initialize:function(source,layerName,options){L.setOptions(this,options),source.addSubLayer||(source=wms.getSourceForUrl(source,options)),this._source=source,this._name=layerName},onAdd:function(){this._source._map||this._source.addTo(this._map),this._source.addSubLayer(this._name)},onRemove:function(){this._source.removeSubLayer(this._name)},setOpacity:function(opacity){this._source.setOpacity(opacity)},bringToBack:function(){this._source.bringToBack()},bringToFront:function(){this._source.bringToFront()}}),wms.layer=function(source,options){return new wms.Layer(source,options)};var sources={};function ajax(url,callback){var context=this;let authorizationBearer=null;ams.Auth.isAuthenticated()&&(authorizationBearer="Bearer "+AuthenticationService.getToken(),url=ams.Auth.getOAuthProxyUrl(url));let headers={};authorizationBearer&&(headers.Authorization=authorizationBearer),fetch(url,{method:"GET",headers:headers,mode:"cors",credentials:"omit",cache:"no-cache"}).then(resp=>{resp.text().then(responseText=>{callback.call(context,responseText)})}).catch(error=>{console.log(error),callback.call(context,"error")})}return wms.getSourceForUrl=function(url,options){return sources[url]||(sources[url]=wms.source(url,options)),sources[url]},wms.TileLayer=L.TileLayer.WMS,wms.tileLayer=L.tileLayer.wms,wms.Overlay=L.Layer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:!1},options:{crs:null,uppercase:!1,attribution:"",opacity:1,isBack:!1,minZoom:0,maxZoom:18},initialize:function(url,options){this._url=url;var params={},opts={};for(var opt in options)opt in this.options?opts[opt]=options[opt]:params[opt]=options[opt];L.setOptions(this,opts),this.wmsParams=L.extend({},this.defaultWmsParams,params)},setParams:function(params){L.extend(this.wmsParams,params),this.update()},getAttribution:function(){return this.options.attribution},onAdd:function(){this.update()},onRemove:function(map){this._currentOverlay&&(map.removeLayer(this._currentOverlay),delete this._currentOverlay),this._currentUrl&&delete this._currentUrl},getEvents:function(){return{moveend:this.update}},update:function(){if(this._map){this.updateWmsParams();var url=this.getImageUrl();if(this._currentUrl!=url){this._currentUrl=url;var bounds=this._map.getBounds(),overlay=L.imageOverlay(url,bounds,{opacity:0});overlay.addTo(this._map),overlay.once("load",_swap,this),(this._map.getZoom()<this.options.minZoom||this._map.getZoom()>this.options.maxZoom)&&this._map.removeLayer(overlay)}}function _swap(){this._map&&(overlay._url==this._currentUrl?(this._currentOverlay&&this._map.removeLayer(this._currentOverlay),this._currentOverlay=overlay,overlay.setOpacity(this.options.opacity?this.options.opacity:1),!0===this.options.isBack&&overlay.bringToBack(),!1===this.options.isBack&&overlay.bringToFront()):this._map.removeLayer(overlay))}},setOpacity:function(opacity){this.options.opacity=opacity,this._currentOverlay&&this._currentOverlay.setOpacity(opacity)},bringToBack:function(){this.options.isBack=!0,this._currentOverlay&&this._currentOverlay.bringToBack()},bringToFront:function(){this.options.isBack=!1,this._currentOverlay&&this._currentOverlay.bringToFront()},updateWmsParams:function(map){map||(map=this._map);var bounds=map.getBounds(),size=map.getSize(),wmsVersion=parseFloat(this.wmsParams.version),crs=this.options.crs||map.options.crs,projectionKey=wmsVersion>=1.3?"crs":"srs",nw=crs.project(bounds.getNorthWest()),se=crs.project(bounds.getSouthEast()),params={width:size.x,height:size.y};params[projectionKey]=crs.code,params.bbox=(wmsVersion>=1.3&&crs===L.CRS.EPSG4326?[se.y,nw.x,nw.y,se.x]:[nw.x,se.y,se.x,nw.y]).join(","),L.extend(this.wmsParams,params)},getImageUrl:function(){var uppercase=this.options.uppercase||!1,pstr=L.Util.getParamString(this.wmsParams,this._url,uppercase);return this._url+pstr}}),wms.overlay=function(url,options){return new wms.Overlay(url,options)},wms.WMSHeader=L.TileLayer.WMS.extend({initialize:function(url,options){L.TileLayer.WMS.prototype.initialize.call(this,url,options),this._initURL=url,this.updateURL()},updateURL:function(){ams.Auth.isAuthenticated()?(this._url=ams.Auth.getOAuthProxyUrl(this._initURL),this._headers=[{header:"Authorization",value:"Bearer "+AuthenticationService.getToken()}]):(this._url=this._initURL,this._headers=[])},createTile:function(coords,done){this.updateURL();const url=this.getTileUrl(coords),img=document.createElement("img");return img.setAttribute("role","presentation"),self=this,fetchImage(url,resp=>{const reader=new FileReader;reader.onload=()=>{img.src=reader.result,self.results&&self.results.next(reader.result)},reader.readAsDataURL(resp),done(null,img)},this._headers,null),img}}),wms.wmsHeader=function(url,options,headers,abort,results){return new wms.WMSHeader(url,options,headers,abort,results)},wms}));